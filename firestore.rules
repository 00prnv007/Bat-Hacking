/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model. Each user has a
 * document in the top-level `/users` collection, and they are the only ones who can read,
 * create, update, or delete their own data. This is a foundational security posture for
 * applications requiring user accounts.
 *
 * Data Structure: All user-specific data is stored under the path `/users/{userId}`, where
 * the document ID `{userId}` directly corresponds to the user's Firebase Authentication UID.
 * This structure creates a secure, scalable user data silo.
 *
 * Key Security Decisions:
 * - User Data Privacy: A user can only access their own document. They cannot read or even
 *   know about the existence of other users' documents.
 * - Disallowing User Listing: To prevent user enumeration attacks and protect privacy, listing
 *   the entire `/users` collection is implicitly and explicitly denied. Clients cannot query
 *   for a list of all application users.
 * - Self-Creation: A newly authenticated user is permitted to create their own user profile
 *   document, but only if the document ID matches their authentication UID.
 *
 * Denormalization for Authorization: This ruleset requires that the user document itself
 * contains an `id` field that matches the user's Auth UID. This is enforced upon creation
 * and ensures the document's internal data is consistent with its path, which is a best
 * practice for relational integrity.
 *
 * Structural Segregation: This principle is not applicable to the current simple data model.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the specified userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for safe updates and deletes.
     * Denies requests that target non-existent documents.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that the user is creating their own profile document and that the
     * internal 'id' field matches their UID for relational integrity.
     */
    function isCreatingOwnProfile(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }

    /**
     * Enforces that the core relational 'id' field cannot be changed after creation.
     */
    function isImmutableId() {
      return request.resource.data.id == resource.data.id;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Controls access to a user's own profile document.
     * @path        /users/{userId}
     * @allow       (get, update, delete) An authenticated user with UID 'user_abc' accessing their own document at `/users/user_abc`.
     * @allow       (create) A new user with UID 'user_xyz' creating their profile at `/users/user_xyz` with `{ "id": "user_xyz", "username": "batman" }`.
     * @deny        (get) User 'user_abc' attempting to read `/users/user_xyz`.
     * @deny        (list) Any user attempting to list all documents in the `/users` collection.
     * @deny        (create) User 'user_abc' attempting to create a profile for 'user_xyz' at `/users/user_xyz`.
     * @principle   Restricts access to a user's own data tree and validates relational integrity.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // CRITICAL: Explicitly deny listing on the users collection to prevent user enumeration.
      allow create: if isCreatingOwnProfile(userId);
      allow update: if isExistingOwner(userId) && isImmutableId();
      allow delete: if isExistingOwner(userId);
    }
  }
}