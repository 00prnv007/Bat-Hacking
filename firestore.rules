/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model, with an
 * exception for a designated admin role. Standard users can only access their own
 * data. The admin user has read-only access to all user data for administrative
 * purposes.
 *
 * Data Structure: All user-specific data is stored under `/users/{userId}`, where
 * the document ID `{userId}` corresponds to the user's Firebase Auth UID.
 *
 * Key Security Decisions:
 * - Admin Read Access: A specific user, identified by their email 'admin@gotham.net',
 *   is granted read-only (`get`, `list`) access to the entire `/users` collection.
 * - User Data Privacy: A non-admin user can only access their own document. They
 *   cannot read, update, or delete other users' documents.
 * - Disallowing User Listing (for non-admins): To prevent user enumeration attacks,
 *   listing the entire `/users` collection is denied for all non-admin users.
 * - Self-Creation: A newly authenticated user can create their own user profile document,
 *   but only if the document ID matches their authentication UID.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the specified userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the requesting user is the designated administrator by email.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.token.email == 'admin@gotham.net';
    }

    /**
     * Validates that the user is creating their own profile document and that the
     * internal 'id' field matches their UID for relational integrity.
     */
    function isCreatingOwnProfile(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }

    /**
     * Enforces that the core relational 'id' field cannot be changed after creation.
     */
    function isImmutableId() {
      return request.resource.data.id == resource.data.id;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Controls access to user profile documents.
     * @path        /users/{userId}
     * @allow       (get, update, delete) An authenticated user on their own document.
     * @allow       (create) A new user creating their own profile.
     * @allow       (get, list) The designated admin user.
     * @deny        (get, list, update, delete) Any non-admin user on another user's document.
     * @principle   Restricts data access to owners, with a read-only exception for admins.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isCreatingOwnProfile(userId);
      allow update: if isOwner(userId) && isImmutableId();
      allow delete: if isOwner(userId);
    }
  }
}
